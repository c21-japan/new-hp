<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マンション売却マッチング | センチュリー21ホームマート</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;900&display=swap" rel="stylesheet"/>
    
    <style>
        :root{
            --gold:#A19276; 
            --gold2:#B8A082; 
            --black:#383635; 
            --ink:#222; 
            --cream:#F8F6F3; 
            --bg:#fff;
            --max:1200px; 
            --shadow:0 8px 24px rgba(0,0,0,.08);
            --accent-pink: #FFB6C1;
            --accent-blue: #4A90E2;
            --accent-green: #90EE90;
            --accent-red: #FF6B6B;
        }
        
        *{box-sizing:border-box}
        html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Noto Sans JP',sans-serif;line-height:1.6}
        a{color:inherit;text-decoration:none}
        img{max-width:100%;display:block;height:auto}
        .container{max-width:var(--max);margin:0 auto;padding:0 16px}
        section{padding:60px 0}
        
        .site-header{
            background:#fff;
            border-bottom:2px solid var(--gold);
            padding:16px 0;
            position:sticky;
            top:0;
            z-index:100;
            box-shadow:0 2px 8px rgba(0,0,0,.08);
        }
        .header-content{
            display:flex;
            justify-content:space-between;
            align-items:center;
            flex-wrap:wrap;
            gap:16px;
        }
        .logo{
            display:flex;
            align-items:center;
            gap:12px;
        }
        .logo img{
            height:40px;
        }
        .nav-menu{
            display:flex;
            gap:24px;
            align-items:center;
        }
        .nav-menu a{
            font-weight:600;
            transition:color 0.3s;
        }
        .nav-menu a:hover{
            color:var(--gold);
        }
        .tel-btn{
            background:linear-gradient(135deg,var(--gold),var(--gold2));
            color:#fff;
            padding:8px 16px;
            border-radius:8px;
            font-weight:700;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }
        
        .page-header{
            background:linear-gradient(135deg,var(--cream),#fff);
            padding:80px 0 60px;
            text-align:center;
            position:relative;
            overflow:hidden;
        }
        .page-header::before{
            content:'';
            position:absolute;
            top:-50%;
            right:-50%;
            width:200%;
            height:200%;
            background:radial-gradient(circle,rgba(161,146,118,0.05),transparent);
            animation:rotate 30s linear infinite;
        }
        @keyframes rotate{
            from{transform:rotate(0deg)}
            to{transform:rotate(360deg)}
        }
        .page-title{
            font-size:clamp(32px,5vw,48px);
            font-weight:900;
            margin-bottom:16px;
            position:relative;
            z-index:1;
        }
        .gold-accent{
            background:linear-gradient(135deg,var(--gold),var(--gold2));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .page-subtitle{
            color:#666;
            font-size:18px;
            position:relative;
            z-index:1;
        }
        
        .stats-section{
            margin-top:-40px;
            position:relative;
            z-index:10;
        }
        .stats-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
            gap:24px;
            max-width:900px;
            margin:0 auto;
        }
        .stat-card{
            background:#fff;
            padding:32px;
            border-radius:16px;
            text-align:center;
            box-shadow:var(--shadow);
            border-top:4px solid var(--gold);
        }
        .stat-number{
            font-size:42px;
            font-weight:900;
            background:linear-gradient(135deg,var(--gold),var(--gold2));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            margin-bottom:8px;
        }
        .stat-label{
            font-size:14px;
            color:#666;
            font-weight:600;
        }
        
        .search-section{
            padding:80px 0;
            background:var(--cream);
        }
        .search-container{
            max-width:800px;
            margin:0 auto;
            text-align:center;
        }
        .search-title{
            font-size:24px;
            font-weight:900;
            margin-bottom:32px;
            color:var(--black);
        }
        .search-box{
            display:flex;
            gap:12px;
            margin-bottom:24px;
            position:relative;
        }
        .search-input{
            flex:1;
            padding:16px 20px;
            border:2px solid #E0E0E0;
            border-radius:10px;
            font-size:16px;
            transition:all 0.3s;
        }
        .search-input:focus{
            outline:none;
            border-color:var(--gold);
            box-shadow:0 0 0 3px rgba(161,146,118,0.1);
        }
        .search-button{
            padding:16px 32px;
            background:linear-gradient(135deg,var(--gold),var(--gold2));
            color:#fff;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:700;
            cursor:pointer;
            transition:all 0.3s;
        }
        .search-button:hover{
            transform:translateY(-2px);
            box-shadow:0 8px 20px rgba(161,146,118,0.3);
        }
        
        .search-suggestions{
            position:absolute;
            top:100%;
            left:0;
            right:0;
            background:#fff;
            border:2px solid var(--gold);
            border-radius:10px;
            margin-top:5px;
            max-height:300px;
            overflow-y:auto;
            display:none;
            z-index:100;
            box-shadow:var(--shadow);
        }
        .search-suggestions.active{
            display:block;
        }
        .suggestion-item{
            padding:12px 20px;
            cursor:pointer;
            transition:background 0.2s;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border-bottom:1px solid #f0f0f0;
        }
        .suggestion-item:hover{
            background:var(--cream);
        }
        .suggestion-name{
            font-weight:600;
            color:var(--black);
        }
        .suggestion-count{
            background:var(--gold);
            color:#fff;
            padding:2px 8px;
            border-radius:999px;
            font-size:12px;
            font-weight:700;
        }
        
        .quick-buttons{
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            justify-content:center;
        }
        .quick-btn{
            padding:10px 20px;
            border:2px solid var(--gold);
            background:#fff;
            color:var(--gold);
            border-radius:999px;
            font-weight:600;
            cursor:pointer;
            transition:all 0.3s;
        }
        .quick-btn:hover{
            background:var(--gold);
            color:#fff;
            transform:translateY(-2px);
        }
        
        .mansions-section{
            padding:80px 0;
        }
        .section-title{
            font-size:clamp(28px,4vw,40px);
            font-weight:900;
            text-align:center;
            margin-bottom:48px;
        }
        .mansions-grid{
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
            gap:30px;
        }
        .mansion-card{
            background:#fff;
            border-radius:16px;
            overflow:hidden;
            box-shadow:var(--shadow);
            transition:transform 0.3s;
            cursor:pointer;
            position:relative;
        }
        .mansion-card:hover{
            transform:translateY(-8px);
        }
        .hot-badge{
            position:absolute;
            top:16px;
            right:16px;
            background:var(--accent-red);
            color:#fff;
            padding:6px 12px;
            border-radius:999px;
            font-size:12px;
            font-weight:700;
            z-index:2;
            animation:pulse 2s infinite;
        }
        @keyframes pulse{
            0%,100%{transform:scale(1)}
            50%{transform:scale(1.05)}
        }
        .mansion-header{
            padding:24px;
            background:var(--cream);
        }
        .mansion-name{
            font-size:20px;
            font-weight:700;
            margin-bottom:8px;
            color:var(--black);
        }
        .mansion-address{
            font-size:14px;
            color:#666;
        }
        .mansion-body{
            padding:24px;
        }
        .hopefuls-highlight{
            background:linear-gradient(135deg,var(--gold),var(--gold2));
            color:#fff;
            padding:16px;
            border-radius:12px;
            text-align:center;
            margin-bottom:20px;
        }
        .hopefuls-number{
            font-size:32px;
            font-weight:900;
        }
        .hopefuls-text{
            font-size:13px;
        }
        .mansion-details{
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:12px;
            margin-bottom:20px;
        }
        .detail-item{
            text-align:center;
        }
        .detail-label{
            font-size:12px;
            color:#999;
            margin-bottom:4px;
        }
        .detail-value{
            font-size:16px;
            font-weight:700;
            color:var(--black);
        }
        .price-range{
            font-size:24px;
            font-weight:900;
            color:var(--gold);
            text-align:center;
            margin-bottom:20px;
        }
        .view-button{
            width:100%;
            padding:14px;
            background:linear-gradient(135deg,var(--gold),var(--gold2));
            color:#fff;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:700;
            cursor:pointer;
            transition:all 0.3s;
        }
        .view-button:hover{
            transform:translateY(-2px);
            box-shadow:0 6px 20px rgba(161,146,118,0.3);
        }
        
        .load-more-button{
            display:block;
            margin:40px auto 0;
            padding:14px 40px;
            background:#fff;
            border:2px solid var(--gold);
            color:var(--gold);
            border-radius:999px;
            font-size:16px;
            font-weight:700;
            cursor:pointer;
            transition:all 0.3s;
        }
        .load-more-button:hover{
            background:var(--gold);
            color:#fff;
        }
        .load-more-button:disabled{
            opacity:0.5;
            cursor:not-allowed;
        }
        
        .modal{
            display:none;
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.7);
            z-index:1000;
            overflow-y:auto;
        }
        .modal.active{
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .modal-content{
            background:#fff;
            border-radius:20px;
            max-width:800px;
            width:90%;
            max-height:90vh;
            overflow-y:auto;
            position:relative;
        }
        .modal-header{
            padding:30px;
            background:var(--cream);
            border-bottom:2px solid var(--gold);
            position:sticky;
            top:0;
            z-index:10;
        }
        .modal-title{
            font-size:24px;
            font-weight:900;
            color:var(--black);
            margin-bottom:8px;
        }
        .close-button{
            position:absolute;
            top:20px;
            right:20px;
            background:#fff;
            border:none;
            width:40px;
            height:40px;
            border-radius:50%;
            font-size:24px;
            cursor:pointer;
            transition:all 0.3s;
            box-shadow:var(--shadow);
        }
        .close-button:hover{
            background:var(--gold);
            color:#fff;
        }
        .modal-body{
            padding:30px;
        }
        .buyer-card{
            background:var(--cream);
            border-radius:16px;
            padding:24px;
            margin-bottom:20px;
            position:relative;
        }
        .buyer-price{
            font-size:28px;
            font-weight:900;
            color:var(--gold);
            margin-bottom:20px;
        }
        .buyer-details{
            display:grid;
            grid-template-columns:repeat(2,1fr);
            gap:12px;
            margin-bottom:20px;
        }
        .buyer-detail{
            display:flex;
            align-items:center;
            gap:8px;
            font-size:14px;
            color:#666;
        }
        .contact-button{
            width:100%;
            padding:14px;
            background:linear-gradient(135deg,var(--accent-green),#7DD87D);
            color:#fff;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:700;
            cursor:pointer;
            transition:all 0.3s;
        }
        .contact-button:hover{
            transform:translateY(-2px);
        }
        
        .loading{
            text-align:center;
            padding:40px;
            color:#666;
        }
        .loading-spinner{
            width:50px;
            height:50px;
            border:4px solid var(--cream);
            border-top:4px solid var(--gold);
            border-radius:50%;
            animation:spin 1s linear infinite;
            margin:0 auto 20px;
        }
        @keyframes spin{
            0%{transform:rotate(0deg)}
            100%{transform:rotate(360deg)}
        }
        
        .data-loading-indicator{
            position:fixed;
            bottom:20px;
            right:20px;
            background:var(--gold);
            color:#fff;
            padding:12px 20px;
            border-radius:999px;
            font-size:14px;
            font-weight:600;
            box-shadow:var(--shadow);
            z-index:1000;
            display:none;
        }
        .data-loading-indicator.active{
            display:block;
        }
        
        .site-footer{
            background:#111;
            color:#eee;
            padding:48px 0 24px;
        }
        .footer-content{
            display:grid;
            gap:32px;
            margin-bottom:32px;
        }
        @media(min-width:768px){
            .footer-content{grid-template-columns:repeat(3,1fr)}
        }
        .footer-section h4{
            color:var(--gold);
            margin-bottom:16px;
            font-size:18px;
        }
        .footer-section ul{
            list-style:none;
            padding:0;
        }
        .footer-section li{
            margin-bottom:8px;
        }
        .footer-section a{
            color:#eee;
            transition:color 0.3s;
        }
        .footer-section a:hover{
            color:var(--gold);
        }
        .footer-bottom{
            text-align:center;
            padding-top:24px;
            border-top:1px solid #333;
            font-size:14px;
            color:#999;
        }
        
        @media(max-width:768px){
            .nav-menu{display:none}
            .search-box{flex-direction:column}
            .mansions-grid{grid-template-columns:1fr}
            .buyer-details{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    <img src="/images/century21logo_gold.png" alt="CENTURY21" onerror="this.style.display='none'">
                    <span style="font-weight:700;font-size:18px">ホームマート</span>
                </a>
                <nav class="nav-menu">
                    <a href="/search.html">物件検索</a>
                    <a href="/assessment.html">売却査定</a>
                    <a href="/reform-water.html">リフォーム</a>
                    <a href="/company/about.html">会社案内</a>
                    <a href="tel:0120438639" class="tel-btn">
                        📞 0120-43-8639
                    </a>
                </nav>
            </div>
        </div>
    </header>

    <section class="page-header">
        <div class="container">
            <h1 class="page-title">マンション売却<span class="gold-accent">マッチング</span></h1>
            <p class="page-subtitle">26,049名の購入希望者データベースから最適な買主を見つけます</p>
        </div>
    </section>
    
    <section class="stats-section">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalBuyers">0</div>
                    <div class="stat-label">購入希望者数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalMansions">0</div>
                    <div class="stat-label">対応マンション</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">96.8%</div>
                    <div class="stat-label">成約率</div>
                </div>
            </div>
        </div>
    </section>
    
    <section class="search-section">
        <div class="container">
            <div class="search-container">
                <h2 class="search-title">マンション名で検索</h2>
                <div style="position:relative">
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" 
                               placeholder="例：ザ・パークハウス、プラウドタワー、ブランズ">
                        <button class="search-button" id="searchButton">検索する</button>
                    </div>
                    <div id="searchSuggestions" class="search-suggestions"></div>
                </div>
                <div class="quick-buttons">
                    <button class="quick-btn" data-area="大阪市">大阪市</button>
                    <button class="quick-btn" data-area="京都市">京都市</button>
                    <button class="quick-btn" data-area="神戸市">神戸市</button>
                    <button class="quick-btn" data-area="奈良市">奈良市</button>
                    <button class="quick-btn" data-area="大津市">大津市</button>
                </div>
            </div>
        </div>
    </section>
    
    <section class="mansions-section">
        <div class="container">
            <h2 class="section-title">購入希望者が多い<span class="gold-accent">マンション</span></h2>
            <div id="mansionsList" class="mansions-grid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>データを読み込んでいます...</p>
                </div>
            </div>
            <button id="loadMoreBtn" class="load-more-button" style="display:none">もっと見る</button>
        </div>
    </section>
    
    <div id="buyerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-button" id="closeModalBtn">×</button>
                <h2 class="modal-title" id="modalTitle">マンション名</h2>
                <p id="modalAddress">住所</p>
            </div>
            <div class="modal-body">
                <div id="buyerCards"></div>
            </div>
        </div>
    </div>
    
    <div id="dataLoadingIndicator" class="data-loading-indicator">
        データ読み込み中...
    </div>
    
    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>センチュリー21ホームマート</h4>
                    <p style="font-size:14px;line-height:1.8;color:#999">
                        〒635-0821<br>
                        奈良県北葛城郡広陵町笠287-1<br>
                        TEL: 0120-43-8639<br>
                        FAX: 050-3183-9576
                    </p>
                </div>
                
                <div class="footer-section">
                    <h4>サービス</h4>
                    <ul>
                        <li><a href="/search.html">物件検索</a></li>
                        <li><a href="/assessment.html">売却査定</a></li>
                        <li><a href="/voluntary-sale.html">任意売却相談</a></li>
                        <li><a href="/reform-water.html">リフォーム</a></li>
                        <li><a href="/recruit.html">採用情報</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>会社情報</h4>
                    <ul>
                        <li><a href="/company/about.html">会社概要</a></li>
                        <li><a href="/company/message.html">代表挨拶</a></li>
                        <li><a href="/company/philosophy.html">企業理念</a></li>
                        <li><a href="/company/access.html">アクセス</a></li>
                        <li><a href="/privacy.html">プライバシーポリシー</a></li>
                        <li><a href="/sitemap.html">サイトマップ</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>© 2025 Century21 HomeMart. All rights reserved.</p>
            </div>
        </div>
    </footer>
    
    <script type="module">
        // グローバル変数
        let MANSION_DB = {};
        let loadedParts = new Set();
        let currentDisplayCount = 20;
        let filteredMansions = [];
        let currentFilter = '';
        
        // データローダー
        class MansionDataLoader {
            constructor() {
                this.totalParts = 5;
                this.loadingPromises = {};
            }
            
            async loadPart(partNumber) {
                if (loadedParts.has(partNumber)) {
                    return;
                }
                
                if (!this.loadingPromises[partNumber]) {
                    this.loadingPromises[partNumber] = this._loadPartImpl(partNumber);
                }
                
                return this.loadingPromises[partNumber];
            }
            
            async _loadPartImpl(partNumber) {
                try {
                    const module = await import(`./mansion_db_part${partNumber}.js`);
                    const partData = module[`MANSION_DB_PART${partNumber}`];
                    
                    Object.assign(MANSION_DB, partData);
                    loadedParts.add(partNumber);
                    
                    // 統計を更新
                    updateStats();
                    
                    console.log(`Part ${partNumber} loaded: ${Object.keys(partData).length} mansions`);
                    return partData;
                } catch (error) {
                    console.error(`Failed to load part ${partNumber}:`, error);
                    return {};
                }
            }
            
            async loadAllParts() {
                const promises = [];
                for (let i = 1; i <= this.totalParts; i++) {
                    promises.push(this.loadPart(i));
                }
                await Promise.all(promises);
            }
            
            async preloadRemainingParts() {
                // requestIdleCallbackを使って残りのパートをバックグラウンドで読み込む
                for (let i = 2; i <= this.totalParts; i++) {
                    if (!loadedParts.has(i)) {
                        if ('requestIdleCallback' in window) {
                            requestIdleCallback(() => this.loadPart(i), { timeout: 5000 });
                        } else {
                            setTimeout(() => this.loadPart(i), 100 * i);
                        }
                    }
                }
            }
        }
        
        const dataLoader = new MansionDataLoader();
        
        // 統計更新
        function updateStats() {
            const totalBuyers = Object.values(MANSION_DB).reduce((sum, m) => 
                sum + (m.buyers?.length || 0), 0
            );
            const totalMansions = Object.keys(MANSION_DB).length;
            
            // アニメーション付きで数値を更新
            animateNumber('totalBuyers', totalBuyers);
            animateNumber('totalMansions', totalMansions);
        }
        
        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentNumber = parseInt(element.textContent.replace(/,/g, '')) || 0;
            const increment = Math.ceil((targetNumber - currentNumber) / 20);
            let current = currentNumber;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= targetNumber) {
                    current = targetNumber;
                    clearInterval(timer);
                }
                element.textContent = current.toLocaleString();
            }, 50);
        }
        
        // マンション表示
        function displayMansions(mansions, append = false) {
            const container = document.getElementById('mansionsList');
            if (!append) {
                container.innerHTML = '';
            }
            
            if (mansions.length === 0) {
                container.innerHTML = '<p style="text-align:center;padding:40px;color:#666">該当するマンションが見つかりませんでした</p>';
                return;
            }
            
            mansions.forEach(mansion => {
                const card = createMansionCard(mansion);
                container.appendChild(card);
            });
            
            // もっと見るボタンの表示/非表示
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (filteredMansions.length > currentDisplayCount) {
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        function createMansionCard(mansion) {
            const card = document.createElement('div');
            card.className = 'mansion-card';
            card.dataset.mansionId = mansion.id;
            
            const buyerCount = mansion.buyers?.length || 0;
            const isHot = buyerCount >= 10;
            
            const avgPrice = mansion.buyers && mansion.buyers.length > 0
                ? Math.round(mansion.buyers.reduce((sum, b) => sum + b.maxPrice, 0) / mansion.buyers.length)
                : 0;
            
            const minPrice = mansion.buyers && mansion.buyers.length > 0
                ? Math.min(...mansion.buyers.map(b => b.maxPrice))
                : 0;
            
            const maxPrice = mansion.buyers && mansion.buyers.length > 0
                ? Math.max(...mansion.buyers.map(b => b.maxPrice))
                : 0;
            
            card.innerHTML = `
                ${isHot ? '<div class="hot-badge">HOT!</div>' : ''}
                <div class="mansion-header">
                    <div class="mansion-name">${mansion.name}</div>
                    <div class="mansion-address">${mansion.address}</div>
                </div>
                <div class="mansion-body">
                    <div class="hopefuls-highlight">
                        <div class="hopefuls-number">${buyerCount}名</div>
                        <div class="hopefuls-text">購入希望者</div>
                    </div>
                    ${buyerCount > 0 ? `
                        <div class="mansion-details">
                            <div class="detail-item">
                                <div class="detail-label">平均予算</div>
                                <div class="detail-value">${(avgPrice / 10000).toFixed(0)}万円</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">築年数</div>
                                <div class="detail-value">${mansion.age}年</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">総戸数</div>
                                <div class="detail-value">${mansion.units}戸</div>
                            </div>
                        </div>
                        <div class="price-range">
                            ${(minPrice / 10000).toFixed(0)}万円 〜 ${(maxPrice / 10000).toFixed(0)}万円
                        </div>
                    ` : '<p style="text-align:center;color:#999;padding:20px">現在購入希望者はいません</p>'}
                    <button class="view-button" onclick="window.showBuyerModal('${mansion.id}')">
                        詳細を見る
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // モーダル表示
        window.showBuyerModal = async function(mansionId) {
            // 全データを読み込む
            const indicator = document.getElementById('dataLoadingIndicator');
            if (loadedParts.size < 5) {
                indicator.classList.add('active');
                await dataLoader.loadAllParts();
                indicator.classList.remove('active');
            }
            
            const mansion = MANSION_DB[mansionId];
            if (!mansion) return;
            
            const modal = document.getElementById('buyerModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalAddress = document.getElementById('modalAddress');
            const buyerCards = document.getElementById('buyerCards');
            
            modalTitle.textContent = mansion.name;
            modalAddress.textContent = mansion.address;
            
            if (mansion.buyers && mansion.buyers.length > 0) {
                buyerCards.innerHTML = mansion.buyers
                    .sort((a, b) => b.maxPrice - a.maxPrice)
                    .map((buyer, index) => `
                        <div class="buyer-card">
                            <div class="buyer-price">
                                予算上限: ${(buyer.maxPrice / 10000).toFixed(0)}万円
                            </div>
                            <div class="buyer-details">
                                <div class="buyer-detail">
                                    <span>👤</span>
                                    <span>${buyer.age}歳 ${buyer.gender === 'M' ? '男性' : '女性'}</span>
                                </div>
                                <div class="buyer-detail">
                                    <span>👨‍👩‍👧‍👦</span>
                                    <span>${buyer.family}</span>
                                </div>
                                <div class="buyer-detail">
                                    <span>💼</span>
                                    <span>${buyer.job}</span>
                                </div>
                                <div class="buyer-detail">
                                    <span>🏠</span>
                                    <span>${buyer.area || '希望なし'}</span>
                                </div>
                            </div>
                            ${buyer.notes ? `<p style="color:#666;font-size:14px;margin:16px 0">📝 ${buyer.notes}</p>` : ''}
                            <button class="contact-button" onclick="window.location.href='tel:0120438639'">
                                この購入希望者に提案する
                            </button>
                        </div>
                    `).join('');
            } else {
                buyerCards.innerHTML = '<p style="text-align:center;color:#999;padding:40px">現在購入希望者はいません</p>';
            }
            
            modal.classList.add('active');
        };
        
        // 検索機能
        async function searchMansions(query) {
            // 検索時は全データを読み込む
            if (loadedParts.size < 5) {
                const indicator = document.getElementById('dataLoadingIndicator');
                indicator.classList.add('active');
                await dataLoader.loadAllParts();
                indicator.classList.remove('active');
            }
            
            const searchTerm = query.toLowerCase();
            return Object.values(MANSION_DB).filter(mansion => 
                mansion.name.toLowerCase().includes(searchTerm) ||
                mansion.address.toLowerCase().includes(searchTerm)
            );
        }
        
        // サジェスト機能
        function showSuggestions(query) {
            const suggestions = document.getElementById('searchSuggestions');
            if (!query) {
                suggestions.classList.remove('active');
                return;
            }
            
            const matches = Object.values(MANSION_DB)
                .filter(m => 
                    m.name.toLowerCase().includes(query.toLowerCase()) ||
                    m.address.toLowerCase().includes(query.toLowerCase())
                )
                .slice(0, 10);
            
            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(m => `
                    <div class="suggestion-item" data-mansion-id="${m.id}">
                        <div>
                            <div class="suggestion-name">${m.name}</div>
                            <div style="font-size:12px;color:#999">${m.address}</div>
                        </div>
                        <div class="suggestion-count">${m.buyers?.length || 0}名</div>
                    </div>
                `).join('');
                suggestions.classList.add('active');
                
                // サジェストアイテムのクリックイベント
                suggestions.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const mansionId = item.dataset.mansionId;
                        window.showBuyerModal(mansionId);
                        suggestions.classList.remove('active');
                        document.getElementById('searchInput').value = '';
                    });
                });
            } else {
                suggestions.classList.remove('active');
            }
        }
        
        // エリアフィルター
        async function filterByArea(area) {
            // フィルター時は全データを読み込む
            if (loadedParts.size < 5) {
                const indicator = document.getElementById('dataLoadingIndicator');
                indicator.classList.add('active');
                await dataLoader.loadAllParts();
                indicator.classList.remove('active');
            }
            
            currentFilter = area;
            filteredMansions = Object.values(MANSION_DB)
                .filter(m => m.address.includes(area))
                .sort((a, b) => (b.buyers?.length || 0) - (a.buyers?.length || 0));
            
            currentDisplayCount = 20;
            displayMansions(filteredMansions.slice(0, currentDisplayCount));
        }
        
        // 初期化
        async function init() {
            // Part1を最初に読み込む
            await dataLoader.loadPart(1);
            
            // 初期表示（購入希望者数でソート）
            filteredMansions = Object.values(MANSION_DB)
                .sort((a, b) => (b.buyers?.length || 0) - (a.buyers?.length || 0));
            displayMansions(filteredMansions.slice(0, currentDisplayCount));
            
            // 残りのパートをバックグラウンドで読み込む
            dataLoader.preloadRemainingParts();
            
            // イベントリスナー設定
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modal = document.getElementById('buyerModal');
            
            // 検索
            searchInput.addEventListener('input', (e) => {
                showSuggestions(e.target.value);
            });
            
            searchButton.addEventListener('click', async () => {
                const query = searchInput.value;
                if (query) {
                    const results = await searchMansions(query);
                    currentFilter = query;
                    filteredMansions = results.sort((a, b) => 
                        (b.buyers?.length || 0) - (a.buyers?.length || 0)
                    );
                    currentDisplayCount = 20;
                    displayMansions(filteredMansions.slice(0, currentDisplayCount));
                }
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchButton.click();
                }
            });
            
            // エリアボタン
            document.querySelectorAll('.quick-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const area = btn.dataset.area;
                    filterByArea(area);
                });
            });
            
            // もっと見る
            loadMoreBtn.addEventListener('click', () => {
                currentDisplayCount += 20;
                const newMansions = filteredMansions.slice(
                    currentDisplayCount - 20,
                    currentDisplayCount
                );
                displayMansions(newMansions, true);
            });
            
            // モーダル閉じる
            closeModalBtn.addEventListener('click', () => {
                modal.classList.remove('active');
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
            
            // サジェスト外クリックで閉じる
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-box')) {
                    document.getElementById('searchSuggestions').classList.remove('active');
                }
            });
        }
        
        // ページ読み込み時に初期化
        init();
    </script>
</body>
</html>
